(function(e){function t(t){for(var a,s,o=t[0],c=t[1],u=t[2],l=0,d=[];l<o.length;l++)s=o[l],Object.prototype.hasOwnProperty.call(n,s)&&n[s]&&d.push(n[s][0]),n[s]=0;for(a in c)Object.prototype.hasOwnProperty.call(c,a)&&(e[a]=c[a]);p&&p(t);while(d.length)d.shift()();return r.push.apply(r,u||[]),i()}function i(){for(var e,t=0;t<r.length;t++){for(var i=r[t],a=!0,o=1;o<i.length;o++){var c=i[o];0!==n[c]&&(a=!1)}a&&(r.splice(t--,1),e=s(s.s=i[0]))}return e}var a={},n={app:0},r=[];function s(t){if(a[t])return a[t].exports;var i=a[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=a,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)s.d(i,a,function(t){return e[t]}.bind(null,a));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/editor/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],c=o.push.bind(o);o.push=t,o=o.slice();for(var u=0;u<o.length;u++)t(o[u]);var p=c;r.push([0,"chunk-vendors"]),i()})({0:function(e,t,i){e.exports=i("56d7")},"01fd":function(e,t,i){"use strict";i("8c5d")},1:function(e,t){},10:function(e,t){},11:function(e,t){},12:function(e,t){},13:function(e,t){},14:function(e,t){},"16a8":function(e,t,i){"use strict";i("e3b5")},"1fd0":function(e,t,i){"use strict";i("9f46")},2:function(e,t){},"2ad8":function(e,t,i){},"2b65":function(e,t,i){},"2f59":function(e,t,i){"use strict";i("6e9d")},3:function(e,t){},3413:function(e,t,i){},4:function(e,t){},"444d":function(e,t,i){},"4cae":function(e,t,i){},5:function(e,t){},"55c0":function(e,t,i){"use strict";i("2ad8")},"56d7":function(e,t,i){"use strict";i.r(t),i.d(t,"router",(function(){return Qt}));i("4160"),i("159b"),i("e260"),i("e6cf"),i("cca6"),i("a79d");var a=i("2b0e"),n=i("8c4f"),r=i("289d"),s=(i("5abe"),i("4cae"),i("1487")),o=i.n(s),c=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"app"}},[e._m(0),i("div",{staticClass:"main"},[i("Header"),i("main",["home"!==e.$route.name&&e.$route.query.url?"collection"===e.$route.name?[i("Collection")]:"mask"===e.$route.name?[i("PixelMask")]:"georeference"===e.$route.name?[i("Georeference")]:"results"===e.$route.name?[i("Results")]:e._e():[i("Home")]],2),"home"!==e.$route.name?i("Drawer"):e._e(),i("Sidebar")],1)])},u=[function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"banner"},[e._v(" This website is not yet finished. Not everything will work as intended, and some things will not work at all. Follow "),i("a",{attrs:{href:"https://twitter.com/bertspaan"}},[e._v("@bertspaan")]),e._v(" for updates. ")])}],p=(i("d81d"),i("b0c0"),i("96cf"),i("1da1")),l=i("5530"),d=i("2f62"),m=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("header",{staticClass:"padding"},[e._m(0),e.$route.query.url?i("nav",[i("div",{staticClass:"buttons field has-addons"},[i("p",{staticClass:"control"},[i("b-button",{attrs:{tag:"router-link","icon-left":"layer-group",to:{name:"collection",query:e.query},type:"is-link is-collection"}},[e._v(" Collection ")])],1),i("p",{staticClass:"control"},[i("b-tooltip",{attrs:{position:"is-bottom",multilined:"",triggers:e.maskTooltipTriggers,"auto-close":["outside","escape"]},scopedSlots:e._u([{key:"content",fn:function(){return[i("b-field",[i("b-switch",{attrs:{value:!0,type:"is-success"}},[e._v(" This image contains one or more maps. ")])],1)]},proxy:!0}],null,!1,6107357)},[i("b-button",{attrs:{tag:"router-link","icon-left":"draw-polygon",to:{name:"mask",query:e.query},type:"is-link is-mask"}},[e._v("Mask")])],1)],1),i("p",{staticClass:"control"},[i("b-button",{attrs:{tag:"router-link","icon-left":"map-pin",to:{name:"georeference",query:e.query},type:"is-link is-georeference"}},[e._v(" Georeference ")])],1),i("p",{staticClass:"control"},[i("b-button",{attrs:{tag:"router-link","icon-left":"globe",to:{name:"results",query:e.query},type:"is-link is-results"}},[e._v(" Results ")])],1)])]):e._e(),i("b-button",{staticClass:"is-light",attrs:{pack:"fas","icon-right":"bars"},on:{click:function(t){return e.setSidebarOpen({open:!0})}}})],1)},f=[function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("h1",[i("a",{attrs:{href:"https://allmaps.org/"}},[i("img",{attrs:{alt:"Allmaps",src:"https://raw.githubusercontent.com/allmaps/style/master/images/allmaps-logo.svg"}})])])}],h={name:"Header",computed:Object(l["a"])(Object(l["a"])({},Object(d["d"])({activeImageId:function(e){return e.ui.activeImageId},maps:function(e){return e.maps.maps}})),{},{maskTooltipTriggers:function(){return[]},query:function(){return{url:this.$route.query.url,image:this.$route.query.image}}}),watch:{"$route.query.url":function(){this.inputUrl=this.$route.query.url}},methods:Object(l["a"])(Object(l["a"])({},Object(d["b"])("ui",["setSidebarOpen"])),{},{handleSubmit:function(){this.$router.push({name:this.$route.name,query:{url:this.inputUrl}})}})},g=h,v=(i("01fd"),i("2877")),b=Object(v["a"])(g,m,f,!1,null,"2464ebaf",null),I=b.exports,y=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("footer",{staticClass:"padding"},[i("div",{staticClass:"drawer box"},[e.drawerOpen?["metadata"===e.drawerOpen?i("Metadata"):"maps"===e.drawerOpen?i("Maps"):"annotation"===e.drawerOpen?i("Annotation"):e._e(),i("hr")]:e._e(),i("div",{staticClass:"base"},[i("div",[i("h3",{staticClass:"label"},[e._v(e._s(e.label))]),i("div",{staticClass:"select-image"},[e.activeImage&&e.imageCount>1?[i("span",[e._v(" Image "+e._s(e.activeImage.index+1)+"/"+e._s(e.imageCount)+" ")]),i("div",{staticClass:"buttons prev-next-buttons"},[i("b-button",{attrs:{size:"is-small","icon-left":"arrow-left",disabled:!e.activeImage.previousImageId,tag:"router-link",type:"is-link",to:{name:e.$route.name,query:{url:e.$route.query.url,image:e.activeImage.previousImageId}}}}),i("b-button",{attrs:{size:"is-small","icon-left":"arrow-right",disabled:!e.activeImage.nextImageId,tag:"router-link",type:"is-link",to:{name:e.$route.name,query:{url:e.$route.query.url,image:e.activeImage.nextImageId}}}})],1)]:e._e()],2)]),i("div",{staticClass:"controls"},[i("div",{staticClass:"buttons drawer-buttons"},[e.hasMetadata?i("b-button",{attrs:{active:"metadata"===e.drawerOpen,"icon-right":"info"},on:{click:function(t){return e.toggleDrawer("metadata")}}}):e._e(),i("b-button",{attrs:{active:"maps"===e.drawerOpen,"icon-right":"list"},on:{click:function(t){return e.toggleDrawer("maps")}}}),i("b-button",{attrs:{active:"annotation"===e.drawerOpen,"icon-right":"code"},on:{click:function(t){return e.toggleDrawer("annotation")}}})],1)])])],2)])},k=[],O=(i("a4d3"),i("e01a"),function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"drawer-content content"},[e.label?i("h3",[e._v(e._s(e.label))]):e._e(),e.description?i("p",[e._v(e._s(e.description))]):e._e(),e.metadata?i("dl",e._l(e.metadata,(function(t,a){return i("div",{key:a},[i("dt",[e._v(e._s(t.label)+" ")]),i("dd",[e._v(e._s(t.value)+" ")])])})),0):e._e()])}),w=[],x={name:"Metadata",computed:Object(l["a"])({},Object(d["c"])("iiif",{label:"label",description:"description",metadata:"metadata"}))},M=x,j=(i("1fd0"),Object(v["a"])(M,O,w,!1,null,"004f1e2a",null)),S=j.exports,P=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.maps&&Object.keys(e.maps).length?i("ol",{staticClass:"drawer-content maps"},e._l(e.maps,(function(t,a,n){return i("li",{key:a,class:{active:e.activeMapId===a},on:{click:function(t){return e.mapClicked(a)}}},[i("div",{staticClass:"map"},[i("div",{staticClass:"index"},[i("div",{staticClass:"thumbnail"},[e.hasPixelMask(t)?i("svg",{attrs:{viewBox:e.thumbnailViewbox(t)}},[i("polygon",{attrs:{points:e.thumbnailPolygonPoints(t)}})]):e._e(),i("span",[e._v(e._s(n+1))])]),i("span",[e._v("Map "+e._s(n+1))])]),i("b-button",{staticClass:"is-white",attrs:{"icon-left":"trash"},on:{click:function(t){return t.stopPropagation(),e.removeMap({mapId:a,source:e.source})}}})],1),e.activeMapId===a&&e.hasGcps(t)?i("ol",{staticClass:"gcps"},e._l(t.gcps,(function(t,n,r){return i("li",{key:n,staticClass:"gcp"},[i("div",{staticClass:"gcp-data"},[i("div",{staticClass:"gcp-icon"},[i("span",{staticClass:"circle"}),i("span",{staticClass:"index"},[e._v(" "+e._s(r+1)+" ")])]),i("span",{staticClass:"gcp-coordinates"},[t.image?[i("span",{staticClass:"gcp-image-coordinate"},[e._v(e._s(e.printImageCoordinate(t.image[0])))]),i("span",{staticClass:"gcp-image-coordinate"},[e._v(e._s(e.printImageCoordinate(t.image[1])))])]:[i("span",{staticClass:"gcp-image-coordinate"}),i("span",{staticClass:"gcp-image-coordinate"})],t.world?[i("span",{staticClass:"gcp-world-coordinate"},[e._v(e._s(e.printWorldCoordinate(t.world[0])))]),i("span",{staticClass:"gcp-world-coordinate"},[e._v(e._s(e.printWorldCoordinate(t.world[1])))])]:[i("span",{staticClass:"gcp-world-coordinate"}),i("span",{staticClass:"gcp-world-coordinate"})]],2)]),i("b-button",{staticClass:"is-white",attrs:{"icon-left":"trash"},on:{click:function(i){return i.stopPropagation(),e.removeGcp({mapId:a,gcpId:n,gcp:t,source:e.source})}}})],1)})),0):e._e()])})),0):i("div",[e._v(" Click and drag to draw mask. ")])},_=[],C=(i("99af"),i("a15b"),i("b64b"),i("2909"));i("a9e3"),i("35b3");function E(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,i=Math.pow(10,t);return Math.round((e+Number.EPSILON)*i)/i}var G={name:"Maps",methods:Object(l["a"])(Object(l["a"])(Object(l["a"])({printImageCoordinate:function(e){return e},printWorldCoordinate:function(e){return E(e,5)},hasPixelMask:function(e){return e&&e.pixelMask&&e.pixelMask.length>0},hasGcps:function(e){return e&&e.gcps&&Object.keys(e.gcps).length>0},maskExtent:function(e){var t=e.pixelMask.map((function(e){return e[0]})),i=e.pixelMask.map((function(e){return e[1]})),a=Math.min.apply(Math,Object(C["a"])(t)),n=Math.max.apply(Math,Object(C["a"])(t)),r=Math.min.apply(Math,Object(C["a"])(i)),s=Math.max.apply(Math,Object(C["a"])(i));return[[a,n],[r,s]]},maskDimensions:function(e){var t=this.maskExtent(e);return[t[0][1]-t[0][0],t[1][1]-t[1][0]]},thumbnailViewbox:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,a=this.maskDimensions(e),n=i/Math.max.apply(Math,Object(C["a"])(a));return"".concat(-t," ").concat(-t," ").concat(a[0]*n+2*t," ").concat(a[1]*n+2*t)},thumbnailPolygonPoints:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,i=this.maskExtent(e),a=this.maskDimensions(e),n=t/Math.max.apply(Math,Object(C["a"])(a)),r=e.pixelMask.map((function(e){return[(e[0]-i[0][0])*n,(e[1]-i[1][0])*n]}));return r.map((function(e){return e.join(",")})).join(" ")}},Object(d["b"])("maps",["removeMap","removeGcp"])),Object(d["b"])("ui",["setActiveMapId"])),{},{mapClicked:function(e){this.setActiveMapId({mapId:e})}}),computed:Object(l["a"])(Object(l["a"])({},Object(d["d"])({activeMapId:function(e){return e.ui.activeMapId},maps:function(e){return e.maps.maps}})),{},{source:function(){return this.$options.name}})},$=G,F=(i("16a8"),Object(v["a"])($,P,_,!1,null,"659b5317",null)),T=F.exports,A=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"drawer-content"},[i("pre",{directives:[{name:"highlightjs",rawName:"v-highlightjs",value:e.annotationString,expression:"annotationString"}]},[i("code",{staticClass:"json"})]),i("div",{staticClass:"block actions buttons"},[i("b-button",{attrs:{"icon-left":"copy"},on:{click:e.copy}},[e._v("Copy")]),i("b-button",{attrs:{"icon-left":"file-download"},on:{click:e.download}},[e._v("Download")]),i("a",{staticClass:"button is-link",attrs:{target:"_blank",href:"https://annotations.allmaps.org/images/"+e.activeImageId,type:"button"}},[e._m(0),i("span",[e._v("Open in new tab")])])],1)])},R=[function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("span",{staticClass:"icon is-small"},[i("i",{staticClass:"fas fa-external-link-alt"})])}],q=(i("d3b7"),i("07ac"),i("3ca3"),i("ddb0"),i("2b3d"),i("7d3a")),D={name:"Annotation",computed:Object(l["a"])(Object(l["a"])(Object(l["a"])({},Object(d["d"])({activeImageId:function(e){return e.ui.activeImageId},maps:function(e){return e.maps.maps}})),Object(d["c"])("ui",{activeImage:"activeImage"})),{},{annotation:function(){var e=this,t=Object.values(this.maps).map((function(t){return Object(l["a"])(Object(l["a"])({},t),{},{pixelMask:[].concat(Object(C["a"])(t.pixelMask),[t.pixelMask[0]]),gcps:Object.values(t.gcps),image:e.getAnnotationImage(t,e.activeImage)})}));return Object(q["a"])(t)},annotationString:function(){return JSON.stringify(this.annotation,null,2)}}),methods:{getAnnotationImage:function(e,t){return 1===e.version?Object(l["a"])(Object(l["a"])({},e.image),{},{dimensions:void 0,width:t.width,height:t.height,quality:t.quality,format:t.format,version:t.version}):e},copy:function(){navigator.clipboard.writeText(this.annotationString),this.$buefy.toast.open({message:"Annotation copied to clipboard!",type:"is-success"})},download:function(){var e=new Blob([this.annotationString],{type:"application/json"}),t=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.style="display: none",i.href=t,i.download="annotation.json",i.click(),window.URL.revokeObjectURL(t),this.$buefy.toast.open({message:"Annotation is downloading",type:"is-success"})}}},U=D,L=(i("fbb4"),Object(v["a"])(U,A,R,!1,null,"27e1be1f",null)),z=L.exports,B={name:"Drawer",components:{Metadata:S,Maps:T,Annotation:z},methods:Object(l["a"])(Object(l["a"])({},Object(d["b"])("ui",["toggleDrawer"])),Object(d["b"])("maps",["undo","redo"])),computed:Object(l["a"])(Object(l["a"])(Object(l["a"])(Object(l["a"])({},Object(d["c"])("iiif",{label:"label",metadata:"metadata",description:"description",imageCount:"imageCount"})),Object(d["c"])("ui",{activeImage:"activeImage"})),Object(d["d"])({drawerOpen:function(e){return e.ui.drawerOpen}})),{},{hasMetadata:function(){return this.label||this.metadata||this.description}})},N=B,V=(i("645a"),Object(v["a"])(N,y,k,!1,null,"524c1226",null)),H=V.exports,J=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("section",[i("b-sidebar",{attrs:{type:"is-light",fullheight:!0,overlay:!0,right:!0},model:{value:e.open,callback:function(t){e.open=t},expression:"open"}},[i("div",{staticClass:"padding"},[i("div",{staticClass:"sidebar-title"},[i("div",[i("img",{attrs:{alt:"Allmaps",src:"https://raw.githubusercontent.com/allmaps/style/master/images/allmaps-logo.svg"}}),i("h2",[e._v("Editor")])]),i("b-button",{staticClass:"is-light",attrs:{"icon-right":"times"},on:{click:function(t){e.open=!1}}})],1),i("div",{staticClass:"container content"},[i("p",[i("router-link",{attrs:{to:{name:"home"}}},[e._v("Open new IIIF URL")])],1),i("h4",[e._v("Keyboard shortcuts")]),i("dl",{staticClass:"shortcuts"},e._l(e.shortcuts,(function(t,a){return i("div",{key:a,staticClass:"shortcut block"},[i("dt",[e._v(e._s(t.label))]),i("dd",{staticClass:"key"},[e._v(e._s(t.key))])])})),0)])])])],1)},W=[],K={name:"Sidebar",data:function(){return{shortcuts:[{label:"Previous image",key:"["},{label:"Next image",key:"]"},{label:"Previous map",key:"{"},{label:"Next map",key:"}"},{label:"Open new IIIF URL",key:"0"},{label:"Collection view",key:"1"},{label:"Mask view",key:"2"},{label:"Georeference view",key:"3"},{label:"Results view",key:"4"},{label:"Open metadata drawer",key:"I"},{label:"Open maps & GCP drawer",key:"M"},{label:"Open annotation drawer",key:"A"},{label:"Close dialog or sidebar",key:"esc"}]}},methods:Object(l["a"])({},Object(d["b"])("ui",["setSidebarOpen"])),computed:{open:{get:function(){return this.$store.state.ui.sidebarOpen},set:function(e){this.setSidebarOpen({open:e})}}}},Q=K,X=(i("2f59"),Object(v["a"])(Q,J,W,!1,null,"121bdc8a",null)),Y=X.exports,Z=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"container below-header content section"},[i("p",{staticClass:"block"},[e._v(" Start georeferencing a map by typing its IIIF Manifest or Image URL in the input box: ")]),i("form",{staticClass:"block"},[i("b-field",[i("b-input",{staticClass:"is-link",attrs:{placeholder:"IIIF manifest or image URL",expanded:"",type:"search"},model:{value:e.inputUrl,callback:function(t){e.inputUrl=t},expression:"inputUrl"}}),i("p",{staticClass:"control"},[i("b-button",{attrs:{"native-type":"submit",type:"is-primary",label:"Load"},on:{click:e.handleSubmit}})],1)],1)],1),e._m(0)])},ee=[function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("p",{staticClass:"block"},[e._v(" For examples of map collections that are accessible with IIIF and URLs you can use, see "),i("a",{attrs:{href:"https://next.observablehq.com/d/8c38533260c50483?collection=@bertspaan/iiif-maps"}},[e._v("this Observable notebook")]),e._v(". ")])}],te={name:"Home",props:{images:Object},data:function(){return{inputUrl:this.$route.query.url}},computed:{},watch:{"$route.query.url":function(){this.inputUrl=this.$route.query.url}},methods:{handleSubmit:function(){this.$router.push({name:"collection",query:{url:this.inputUrl}})}}},ie=te,ae=(i("fc82"),Object(v["a"])(ie,Z,ee,!1,null,"3aab7ea2",null)),ne=ae.exports,re=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"background"},[i("section",{staticClass:"container below-header"},[i("ol",{staticClass:"images"},e._l(e.imagesById,(function(t,a){return i("li",{key:a,class:{active:e.activeImageId===a}},[i("router-link",{attrs:{to:{name:"collection",query:{image:a,url:e.$route.query.url}}}},[t.stub?[i("div",[i("b-icon",{attrs:{pack:"fas",icon:"sync-alt",size:"is-large","custom-class":"fa-spin"}})],1)]:[t.stub?e._e():i("Thumbnail",{attrs:{image:t}})]],2),i("div",{staticClass:"icons"})],1)})),0)])])},se=[],oe=(i("4de4"),i("45fc"),function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.singleImage?i("img",{staticClass:"single",attrs:{src:e.getImageUrl(e.image,e.thumbnail)}}):i("div",{staticClass:"tiled",style:{width:e.tilesWidth*e.scale+"px",height:e.tilesHeight*e.scale+"px",gridTemplateRows:"repeat("+e.rowCount+", auto)",gridTemplateColumns:"repeat("+e.columnCount+", auto)"}},[e._l(e.thumbnail,(function(t,a){return[e._l(t,(function(t,n){return[i("img",{key:n+","+a,style:{width:t.size.width*e.scale+"px"},attrs:{src:e.getImageUrl(e.image,e.removeHeight(t))}})]}))]}))],2)}),ce=[],ue=(i("13d5"),i("e383")),pe={name:"Thumbnail",props:{image:Object,width:{type:Number,default:200}},computed:{singleImage:function(){return!Array.isArray(this.thumbnail)},thumbnail:function(){return Object(ue["b"])(this.image,this.width)},rowCount:function(){return this.thumbnail.length},columnCount:function(){var e=this.thumbnail[0];return e.length},tilesWidth:function(){var e=this.thumbnail[0];return e.reduce((function(e,t){return e+t.size.width}),0)},tilesHeight:function(){return this.thumbnail.reduce((function(e,t){return e+t[0].size.height}),0)},scale:function(){return this.width/Math.max(this.tilesWidth,this.tilesHeight)}},methods:{getImageUrl:ue["a"],getThumbnail:ue["b"],removeHeight:function(e){var t=e.region,i=e.size;return{region:t,size:{width:i.width}}}}},le=pe,de=(i("cc7b"),Object(v["a"])(le,oe,ce,!1,null,"bbefe63c",null)),me=de.exports,fe={name:"Collection",components:{Thumbnail:me},computed:Object(l["a"])({},Object(d["d"])({imagesById:function(e){return e.iiif.imagesById},maps:function(e){return e.maps.maps},activeImageId:function(e){return e.ui.activeImageId}})),methods:{handleSubmit:function(){this.$router.push({name:this.$route.name,query:{url:this.inputUrl}})},mapsForImage:function(e){return Object.values(this.maps).filter((function(t){return t.imageId===e}))},hasGcps:function(e){var t=this.mapsForImage(e);return t.some((function(e){return e.gcps&&Object.keys(e.gcps).length}))},hasPixelMask:function(e){var t=this.mapsForImage(e);return t.some((function(e){return e.pixelMask&&e.pixelMask.length}))}}},he=fe,ge=(i("67b8"),Object(v["a"])(he,re,se,!1,null,"f6a0d8ce",null)),ve=ge.exports,be=function(){var e=this,t=e.$createElement;e._self._c;return e._m(0)},Ie=[function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"panes"},[i("div",{staticClass:"iiif zoom-controls-bottom-left",attrs:{id:"iiif"}}),i("div",{staticClass:"map zoom-controls-bottom-right",attrs:{id:"map"}})])}],ye=i("ade3"),ke=i("5eee"),Oe=i("4cdf"),we=i("a2c7"),xe=i("480c"),Me=i("3e6b"),je=i("c807"),Se=i("ac29"),Pe=i("f403"),_e=i("a2e1"),Ce=i("5831"),Ee=i("e29f"),Ge=i("2ef1"),$e=i("6c77"),Fe=i("8682"),Te=i("ce2c"),Ae=i("83a6"),Re=i("8295"),qe=i("c3bc"),De=i("e07d"),Ue=i("256f"),Le=i("74f0"),ze=i("06f8");function Be(e){return Object(ze["j"])(e)&&Object(ze["k"])(e)}function Ne(e){return Ve.apply(this,arguments)}function Ve(){return Ve=Object(p["a"])(regeneratorRuntime.mark((function e(t){var i,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Object(Le["c"])();case 2:return i=e.sent,a=[[0,0],[0,t.height],[t.width,t.height],[t.width,0]],e.abrupt("return",{id:i,image:{id:t.id,uri:t.uri,width:t.width,height:t.height,version:t.version,quality:t.quality,format:t.format},pixelMask:a});case 5:case"end":return e.stop()}}),e)}))),Ve.apply(this,arguments)}var He={name:"Georeference",data:function(){return{singleIiifFeatures:[],singleMapFeatures:[],dimensions:void 0}},watch:{activeMapId:function(){this.iiifSource.changed(),this.initalizeGCPs(this.activeMap)},activeImage:function(){this.updateImage(this.activeImage),this.initalizeGCPs(this.activeMap)}},methods:Object(l["a"])(Object(l["a"])({},Object(d["b"])("maps",["insertMap","insertGcp","replaceGcp","removeGcp"])),{},{onStoreMutation:function(e){if(e.payload.source!==this.source){var t=e.payload.mapId;if("maps/removeMap"!==e.type){if(this.activeMapId===t){var i=e.payload.gcpId,a=e.payload.gcp;if("maps/removeGcp"===e.type){var n=this.iiifSource.getFeatureById(i),r=this.mapSource.getFeatureById(i);n&&this.iiifSource.removeFeature(n),r&&this.mapSource.removeFeature(r)}else if("maps/insertGcp"===e.type||"maps/replaceGcp"===e.type){var s=this.iiifSource.getFeatureById(i),o=this.mapSource.getFeatureById(i);if(a.image){var c=a.image;if(s)s.getGeometry().setCoordinates([c[0],-c[1]]);else{var u=this.iiifSource.getFeatures().length,p=new Oe["a"]({index:u,geometry:new Pe["a"]([c[0],-c[1]])});p.setId(a.id),a.world||this.singleIiifFeatures.push(p),this.iiifSource.addFeature(p)}}if(a.world){var l=a.world;if(o)o.getGeometry().setCoordinates(Object(Ue["d"])(l));else{var d=this.mapSource.getFeatures().length,m=(new _e["a"]).readFeature({type:"Feature",id:a.id,properties:{index:d},geometry:{type:"Point",coordinates:l}},{featureProjection:"EPSG:3857"});m.setId(a.id),a.image||this.singleMapFeatures.push(m),this.mapSource.addFeature(m)}}}}}else this.clearGcps()}},onResize:function(){this.iiifOl&&this.mapOl&&(this.iiifOl.updateSize(),this.mapOl.updateSize())},pointDifference:function(){var e=this.iiifSource.getFeatures(),t=this.mapSource.getFeatures();return e.length-t.length},gcpFromGcpId:function(e){var t,i,a=this.iiifSource.getFeatureById(e),n=this.mapSource.getFeatureById(e);return a&&(t=this.iiifFeatureToPoint(a)),n&&(i=this.mapFeatureToPoint(n)),{id:e,image:t,world:i}},clearGcps:function(){this.mapSource.clear(),this.iiifSource.clear(),this.singleIiifFeatures=[],this.singleMapFeatures=[]},initalizeGCPs:function(e){var t=this;this.clearGcps();var i=e&&Object.values(e.gcps)||[];if(i&&0!==i.length){var a=i.map((function(e,i){var a=e.image;if(a){var n=new Oe["a"]({index:i,geometry:new Pe["a"]([a[0],-a[1]])});return n.setId(e.id),e.world||t.singleIiifFeatures.push(n),n}})).filter((function(e){return e})),n=i.map((function(e,i){var a=e.world;if(a){var n=(new _e["a"]).readFeature({type:"Feature",id:e.id,properties:{index:i},geometry:{type:"Point",coordinates:a}},{featureProjection:"EPSG:3857"});return n.setId(e.id),e.image||t.singleMapFeatures.push(n),n}})).filter((function(e){return e}));if(this.iiifSource.addFeatures(a),this.mapSource.addFeatures(n),n.length>0){var r=this.mapSource.getExtent();this.mapOl.getView().fit(r,{padding:[25,25,25,25],maxZoom:18})}}},iiifFeatureToPoint:function(e){var t=e.getGeometry().getCoordinates();return[Math.round(t[0]),Math.round(-t[1])]},mapFeatureToPoint:function(e){var t=e.getGeometry().clone();return t.transform("EPSG:3857","EPSG:4326"),t.getCoordinates().map((function(e){return E(e,7)}))},onEdited:function(){var e=Object(p["a"])(regeneratorRuntime.mark((function e(t){var i,a,n,r,s,o,c,u,p,l,d,m,f,h,g,v,b,I;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if("addfeature"!==t.type){e.next=32;break}if(i=t.feature,!i.getId()){e.next=4;break}return e.abrupt("return");case 4:if(r=this.pointDifference(),!(r>0&&t.target===this.iiifSource||r<0&&t.target===this.mapSource)){e.next=13;break}return e.next=8,Object(Le["c"])();case 8:a=e.sent,n=!0,t.target===this.iiifSource?this.singleIiifFeatures.push(i):this.singleMapFeatures.push(i),e.next=14;break;case 13:t.target===this.iiifSource?(s=this.singleMapFeatures.shift(),a=s.getId()):(o=this.singleIiifFeatures.shift(),a=o.getId());case 14:if(i.setId(a),i.getProperties(),c=t.target===this.iiifSource?this.iiifSource.getFeatures().length-1:this.mapSource.getFeatures().length-1,i.setProperties({index:c}),u=this.gcpFromGcpId(a),!this.activeMapId){e.next=24;break}p=this.activeMapId,n?this.insertGcp({mapId:p,gcpId:a,gcp:u,source:this.source}):this.replaceGcp({mapId:p,gcpId:a,gcp:u,source:this.source}),e.next=30;break;case 24:return e.next=26,Ne(this.activeImage);case 26:l=e.sent,d=l.id,m=l.image,f=l.pixelMask,h=Object(ye["a"])({},a,u),this.insertMap({mapId:d,image:m,pixelMask:f,gcps:h,source:this.source});case 30:e.next=33;break;case 32:"modifyend"===t.type&&(g=this.activeMapId,v=t.features.item(0),b=v.getId(),b?(I=this.gcpFromGcpId(b),this.replaceGcp({mapId:g,gcpId:b,gcp:I,source:this.source})):console.error("GCP without ID encountered"));case 33:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}(),updateImage:function(e){if(e&&!e.stub){var t=new De["b"](e.sourceData).getTileSourceOptions();if(void 0===t||void 0===t.version)throw new Error("Data seems to be no valid IIIF image information.");t.zDirection=-1;var i=new qe["a"](t);this.iiifLayer.setSource(i);var a=i.getTileGrid().getExtent();this.dimensions=[a[2],-a[1]],this.iiifOl.setView(new we["a"]({enableRotation:!1,resolutions:i.getTileGrid().getResolutions(),extent:a,constrainOnlyCenter:!0})),this.iiifOl.getView().fit(i.getTileGrid().getExtent(),{padding:[90,10,90,10]})}},gcpStyle:function(e){return new $e["c"]({stroke:new Fe["a"]({color:"#E10800",width:3}),image:new Te["a"]({radius:7,fill:new Ae["a"]({color:"#E10800"})}),text:this.gcpTextStyle(e)})},gcpTextStyle:function(e){return new Re["a"]({scale:1.5,text:this.gcpLabel(e),fill:new Ae["a"]({color:"#000"}),stroke:new Fe["a"]({color:"#fff",width:2}),offsetX:14,offsetY:14})},gcpLabel:function(e){var t=e.getProperties();return String(t.index+1)}}),computed:Object(l["a"])(Object(l["a"])(Object(l["a"])(Object(l["a"])({},Object(d["d"])({activeMapId:function(e){return e.ui.activeMapId},maps:function(e){return e.maps.maps}})),Object(d["c"])("maps",{activeMap:"activeMap"})),Object(d["c"])("ui",{activeImage:"activeImage"})),{},{source:function(){return this.$options.name}}),mounted:function(){this.iiifLayer=new xe["a"],this.iiifSource=new Ce["a"],this.iiifVector=new Me["a"]({source:this.iiifSource,style:this.gcpStyle}),this.iiifOl=new ke["a"]({layers:[this.iiifLayer,this.iiifVector],target:"iiif"});var e=[{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community"},{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012"},{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"}];this.mapLayer=new xe["a"]({source:new Ge["a"]({url:e[0].url})}),this.mapSource=new Ce["a"],this.mapVector=new Me["a"]({source:this.mapSource,style:this.gcpStyle}),this.mapOl=new ke["a"]({layers:[this.mapLayer,this.mapVector],controls:[new Ee["a"]],target:"map",view:new we["a"]({enableRotation:!1,center:Object(Ue["d"])([0,0]),zoom:2})}),this.iiifModify=new je["a"]({source:this.iiifSource,deleteCondition:Be}),this.mapModify=new je["a"]({source:this.mapSource,deleteCondition:Be}),this.iiifOl.addInteraction(this.iiifModify),this.mapOl.addInteraction(this.mapModify);var t=new Se["a"]({source:this.iiifSource,type:"Point"}),i=new Se["a"]({source:this.mapSource,type:"Point"});this.iiifOl.addInteraction(t),this.mapOl.addInteraction(i),this.iiifSource.on("addfeature",this.onEdited),this.iiifModify.on("modifyend",this.onEdited),this.mapSource.on("addfeature",this.onEdited),this.mapModify.on("modifyend",this.onEdited),this.storeUnsubscribe=this.$store.subscribe(this.onStoreMutation),this.updateImage(this.activeImage),this.initalizeGCPs(this.activeMap)},beforeDestroy:function(){this.iiifSource.un("addfeature",this.onEdited),this.iiifModify.un("modifyend",this.onEdited),this.mapSource.un("addfeature",this.onEdited),this.mapModify.un("modifyend",this.onEdited),this.storeUnsubscribe()}},Je=He,We=(i("55c0"),Object(v["a"])(Je,be,Ie,!1,null,"836ffa9e",null)),Ke=We.exports,Qe=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"iiif zoom-controls-bottom-left",attrs:{id:"iiif"}})},Xe=[],Ye=(i("caad"),i("fb6a"),i("5bc3")),Ze={name:"PixelMask",data:function(){return{dimensions:void 0}},watch:{activeMapId:function(){this.updateStyles(),this.initializePixelMasks(this.maps)},activeImage:function(){this.initializePixelMasks(this.maps),this.updateImage(this.activeImage)}},computed:Object(l["a"])(Object(l["a"])(Object(l["a"])({},Object(d["d"])({activeMapId:function(e){return e.ui.activeMapId},maps:function(e){return e.maps.maps}})),Object(d["c"])("ui",{activeImage:"activeImage"})),{},{source:function(){return this.$options.name}}),methods:Object(l["a"])(Object(l["a"])({},Object(d["b"])("maps",["insertMap","insertPixelMaskPoint","removePixelMaskPoint","replacePixelMaskPoint"])),{},{addFeature:function(e,t){var i=new Oe["a"]({index:t,geometry:new Ye["a"](this.maskToPolygon(e.pixelMask))});i.setId(e.id),this.iiifSource.addFeature(i)},onStoreMutation:function(e){if(e.payload.source!==this.source){var t=e.payload.mapId;if("maps/insertMap"===e.type){var i=e.payload.map,a=Object.keys(this.maps).length-1;this.addFeature(i,a)}else if("maps/removeMap"===e.type){var n=this.iiifSource.getFeatureById(t);n&&this.iiifSource.removeFeature(n)}else if(["maps/insertPixelMaskPoint","maps/replacePixelMaskPoint","maps/removePixelMaskPoint"].includes(e.type)){var r=this.iiifSource.getFeatureById(t);r.setGeometry(new Ye["a"](this.maskToPolygon(this.maps[t].pixelMask)))}}},onResize:function(){this.iiifOl&&this.iiifOl.updateSize()},updateStyles:function(){this.iiifVector.setStyle(this.maskStyle)},initializePixelMasks:function(e){this.iiifSource.clear(),e&&Object.values(e).forEach(this.addFeature)},pointsEqual:function(e,t){return e[0]===t[0]&&e[1]===t[1]},polygonDifference:function(e,t){var i=Math.min(e.length,t.length),a=0;for(a;a<i;a++)if(!this.pointsEqual(e[a],t[a]))break;return e.length<t.length?{index:a,operation:"insert",pixelMaskPoint:t[a]}:e.length>t.length?{index:a,operation:"remove",pixelMaskPoint:e[a]}:a<i?{index:a,operation:"replace",pixelMaskPoint:t[a]}:void 0},onEdited:function(){var e=Object(p["a"])(regeneratorRuntime.mark((function e(t){var i,a,n,r,s,o,c,u,p,l;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if("addfeature"!==t.type){e.next=12;break}if(i=t.feature,!i.getId()){e.next=4;break}return e.abrupt("return");case 4:return i.setProperties({index:Object.keys(this.maps).length}),e.next=7,Object(Le["c"])();case 7:a=e.sent,i.setId(a),this.insertMap({mapId:a,image:{id:this.activeImage.id,uri:this.activeImage.uri,width:this.activeImage.width,height:this.activeImage.height,version:this.activeImage.version,quality:this.activeImage.quality,format:this.activeImage.format},pixelMask:this.featurePolygon(i),source:this.source}),e.next=29;break;case 12:if("modifystart"!==t.type){e.next=17;break}n=t.features.item(0),n&&(this.modifyingPolygon=this.featurePolygon(n)),e.next=29;break;case 17:if("modifyend"!==t.type){e.next=29;break}if(!(t.features.getLength()>1)){e.next=22;break}console.error("Multiple masks edited at once!"),e.next=24;break;case 22:if(0!==t.features.getLength()){e.next=24;break}return e.abrupt("return");case 24:r=t.features.item(0),s=r.getId(),o=this.polygonDifference(this.modifyingPolygon,this.featurePolygon(r)),o&&(c=o.operation,u=o.index,p=o.pixelMaskPoint,l={mapId:s,index:u,pixelMaskPoint:p,source:this.source},"insert"===c?this.insertPixelMaskPoint(l):"replace"===c?this.replacePixelMaskPoint(l):"remove"===c&&this.removePixelMaskPoint(l)),this.modifyingPolygon=void 0;case 29:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}(),updateImage:function(e){if(e&&!e.stub){var t=new De["b"](e.sourceData).getTileSourceOptions();if(void 0===t||void 0===t.version)throw new Error("Data seems to be no valid IIIF image information.");t.zDirection=-1;var i=new qe["a"](t);this.iiifLayer.setSource(i);var a=i.getTileGrid().getExtent();this.dimensions=[a[2],-a[1]],this.iiifOl.setView(new we["a"]({enableRotation:!1,resolutions:i.getTileGrid().getResolutions(),extent:a,constrainOnlyCenter:!0})),this.iiifOl.getView().fit(i.getTileGrid().getExtent(),{padding:[90,10,90,10]})}},polygonToMask:function(e){return e[0].slice(0,-1).map((function(e){return[e[0],-e[1]].map((function(e){return E(e,0)}))}))},maskToPolygon:function(e){return[[].concat(Object(C["a"])(e.map((function(e){return[e[0],-e[1]]}))),[[e[0][0],-e[0][1]]])]},featurePolygon:function(e){return this.polygonToMask(e.getGeometry().getCoordinates())},maskTextStyle:function(e){return new Re["a"]({scale:1.5,text:this.maskLabel(e),fill:new Ae["a"]({color:"#000"}),stroke:new Fe["a"]({color:"#fff",width:2}),placement:"point",align:"center",baseline:"middle",overflow:!0})},maskLabel:function(e){var t=e.getProperties();return"Map ".concat(t.index+1)},maskStyle:function(e){var t=this.activeMapId===e.getId();return new $e["c"]({stroke:new Fe["a"]({color:"#C552B5",width:t?5:2}),text:this.maskTextStyle(e)})}}),mounted:function(){this.iiifLayer=new xe["a"],this.iiifSource=new Ce["a"],this.iiifVector=new Me["a"]({source:this.iiifSource,style:this.maskStyle}),this.iiifOl=new ke["a"]({layers:[this.iiifLayer,this.iiifVector],target:"iiif"}),this.iiifModify=new je["a"]({source:this.iiifSource,deleteCondition:Be}),this.iiifOl.addInteraction(this.iiifModify);var e=new Se["a"]({source:this.iiifSource,type:"Polygon",freehandCondition:function(e){return!1}});this.iiifOl.addInteraction(e),this.iiifSource.on("addfeature",this.onEdited),this.iiifModify.on("modifystart",this.onEdited),this.iiifModify.on("modifyend",this.onEdited),this.storeUnsubscribe=this.$store.subscribe(this.onStoreMutation),this.updateImage(this.activeImage),this.initializePixelMasks(this.maps),this.updateStyles()},beforeDestroy:function(){this.iiifSource.un("addfeature",this.onEdited),this.iiifModify.un("modifystart",this.onEdited),this.iiifModify.un("modifyend",this.onEdited),this.storeUnsubscribe()}},et=Ze,tt=(i("9f69"),Object(v["a"])(et,Qe,Xe,!1,null,"094768ce",null)),it=tt.exports,at=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"background section"},[i("div",{staticClass:"container content"},[i("div",[i("p",{staticClass:"block"},[e._v(" Results page coming soon. "),e.activeImageId?i("span",[e._v(" For now, you can view this map in the "),i("a",{attrs:{href:e.viewerUrl}},[e._v("Allmaps Viewer")]),e._v(". ")]):e._e()])])])])},nt=[],rt={name:"Results",computed:Object(l["a"])(Object(l["a"])(Object(l["a"])({},Object(d["c"])("iiif",{manifestId:"manifestId"})),Object(d["d"])({activeImageId:function(e){return e.ui.activeImageId}})),{},{viewerUrl:function(){var e,t="https://viewer.allmaps.org/#type=annotation&data=data:text/x-url,",i="https://annotations.allmaps.org";return e=this.manifestId?"".concat(i,"/manifests/").concat(this.manifestId):"".concat(i,"/images/").concat(this.activeImageId),"".concat(t).concat(encodeURIComponent(e))}})},st=rt,ot=(i("ca39"),Object(v["a"])(st,at,nt,!1,null,"16cdd194",null)),ct=ot.exports,ut=i("d096"),pt=i("825c"),lt=i.n(pt),dt=(i("0481f"),i("4069"),i("53ca")),mt=function(e){return"object"===Object(dt["a"])(e)},ft=function(e){return Array.isArray(e)};function ht(e){if(ft(e[0]))return e.map(ht).flat();var t=e[0];return[gt(t,e.slice(1))].flat()}function gt(e,t){if(ft(t[0]))return t.map((function(t){return gt(e,t)}));if(mt(t[0]))return{mapId:e,type:"map",instructions:t[0]};var i=t[0];return vt(e,i,t.slice(1))}function vt(e,t,i){if(ft(i[0]))return i.map((function(i){return vt(e,t,i)}));if(mt(i[0]))throw new Error("Oh no!");var a=i[0];return{mapId:e,type:t,key:a,instructions:i[1]}}var bt="wss://api.allmaps.org",It=i("8263"),yt=(Object({NODE_ENV:"production",VUE_APP_API_URL:"https://api.allmaps.org",VUE_APP_WS_API_URL:"wss://api.allmaps.org",BASE_URL:"/editor/"}).VUE_APP_SERVER_URL,{name:"app",components:{Header:I,Drawer:H,Sidebar:Y,Home:ne,Collection:ve,Georeference:Ke,PixelMask:it,Results:ct},methods:Object(l["a"])(Object(l["a"])(Object(l["a"])(Object(l["a"])({},Object(d["b"])("ui",["setActiveImageId","setActiveMapId","toggleDrawer","setSidebarOpen"])),Object(d["b"])("maps",["setMaps","resetMaps","insertMap","removeMap","insertPixelMaskPoint","removePixelMaskPoint","replacePixelMaskPoint","insertGcp","replaceGcp","removeGcp"])),Object(d["b"])("iiif",["setIiifUrl"])),{},{initializeDoc:function(){var e,t="ShareDB";this.doc.type?e="Someone has started georeferencing this map, you can continue editing to improve their work.":(this.doc.create({},It.type.name),e="Youâ€™re editing a new map."),e+=" All edits are automatically saved in the Allmaps database.",this.$buefy.snackbar.open({message:e,position:"is-top"});var i=JSON.parse(JSON.stringify(this.doc.data));this.setMaps({maps:i,source:t})},getDoc:function(){this.doc&&(this.doc.removeListener("op",this.remoteOperation),this.doc.unsubscribe(),this.doc.destroy()),this.doc=this.connection.get("images",this.activeImageId),this.doc.subscribe(this.initializeDoc),this.doc.on("op",this.remoteOperation)},remoteOperation:function(e,t){var i=this;if(!t&&e){var a="ShareDB",n=ht(e);n.forEach((function(e){var t=e.mapId,n=e.type,r=e.key,s=e.instructions;if("map"===n&&s.i){var o=s.i,c=o.image,u=o.pixelMask,p=o.gcps;i.insertMap({mapId:t,image:c,pixelMask:u,gcps:p,source:a})}else if("map"===n&&s.r)i.removeMap({mapId:t,source:a});else if("pixelMask"===n){var l=r,d=s.i;s.r&&d?i.replacePixelMaskPoint({mapId:t,index:l,pixelMaskPoint:d,source:a}):d?i.insertPixelMaskPoint({mapId:t,index:l,pixelMaskPoint:d,source:a}):s.r&&i.removePixelMaskPoint({mapId:t,index:l,pixelMaskPoint:d,source:a})}else if("gcps"===n){var m=r,f=s.i;s.r&&f?i.replaceGcp({mapId:t,gcpId:m,gcp:f,source:a}):f?i.insertGcp({mapId:t,gcpId:m,gcp:f,source:a}):s.r&&i.removeGcp({mapId:t,gcpId:m,source:a})}}))}},onStoreMutation:function(e){if("ShareDB"!==e.payload.source)if("maps/insertMap"===e.type){var t=e.payload,i=t.mapId,a=t.map;this.doc.submitOp(It.insertOp([i],JSON.parse(JSON.stringify(a))))}else if("maps/removeMap"===e.type){var n=e.payload.mapId;this.doc.submitOp(It.removeOp([n]))}else if("maps/insertPixelMaskPoint"===e.type){var r=e.payload,s=r.mapId,o=r.index,c=r.pixelMaskPoint;this.doc.submitOp(It.insertOp([s,"pixelMask",o],c))}else if("maps/removePixelMaskPoint"===e.type){var u=e.payload,p=u.mapId,d=u.index,m=u.pixelMaskPoint;this.doc.submitOp(It.removeOp([p,"pixelMask",d],m))}else if("maps/replacePixelMaskPoint"===e.type){var f=e.payload,h=f.mapId,g=f.index,v=f.pixelMaskPoint;this.doc.submitOp(It.replaceOp([h,"pixelMask",g],!0,v))}else if("maps/insertGcp"===e.type){var b=e.payload,I=b.mapId,y=b.gcpId,k=b.gcp;this.doc.submitOp(It.insertOp([I,"gcps",y],Object(l["a"])({},k)))}else if("maps/replaceGcp"===e.type){var O=e.payload,w=O.mapId,x=O.gcpId,M=O.gcp;this.doc.submitOp(It.replaceOp([w,"gcps",x],!0,Object(l["a"])({},M)))}else if("maps/removeGcp"===e.type){var j=e.payload,S=j.mapId,P=j.gcpId;j.gcp;this.doc.submitOp(It.removeOp([S,"gcps",P]))}},goToRoute:function(e){this.$router.push({name:e,query:this.$route.query})},keyPressHandler:function(e){if("["===e.key){if(!this.activeImage||!this.activeImage.previousImageId)return;this.$router.push({name:this.$route.name,query:Object(l["a"])(Object(l["a"])({},this.$route.query),{},{image:this.activeImage.previousImageId})})}else if("]"===e.key){if(!this.activeImage||!this.activeImage.nextImageId)return;this.$router.push({name:this.$route.name,query:Object(l["a"])(Object(l["a"])({},this.$route.query),{},{image:this.activeImage.nextImageId})})}else"{"===e.key?this.setActiveMapId({mapId:this.previousMapId}):"}"===e.key?this.setActiveMapId({mapId:this.nextMapId}):"1"===e.key?this.goToRoute("collection"):"2"===e.key?this.goToRoute("mask"):"3"===e.key?this.goToRoute("georeference"):"4"===e.key?this.goToRoute("results"):"0"===e.key?this.goToRoute("home"):"i"===e.key?this.toggleDrawer("metadata"):"m"===e.key?this.toggleDrawer("maps"):"a"===e.key&&this.toggleDrawer("annotation")}}),computed:Object(l["a"])(Object(l["a"])(Object(l["a"])({},Object(d["d"])({activeImageId:function(e){return e.ui.activeImageId},maps:function(e){return e.maps.maps}})),Object(d["c"])("ui",{activeImage:"activeImage",previousMapId:"previousMapId",nextMapId:"nextMapId"})),{},{fullscreen:function(){return"mask"===this.$route.name||"georeference"===this.$route.name||"results"===this.$route.name}}),watch:{"$route.name":function(){this.setSidebarOpen({open:!1})},"$route.query.url":function(e){this.setSidebarOpen({open:!1}),this.setIiifUrl({url:e,imageId:this.$route.query.image})},"$route.query.image":function(e){e&&this.activeImageId!==e&&(this.setSidebarOpen({open:!1}),this.setActiveImageId({imageId:e}))},activeImageId:function(){this.resetMaps(),this.getDoc()}},mounted:function(){var e=Object(p["a"])(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:t=this.$route.query.url,t&&this.setIiifUrl({url:t,imageId:this.$route.query.image}),window.addEventListener("keypress",this.keyPressHandler),this.rws=new ut["a"](bt),lt.a.types.register(It.type),this.connection=new lt.a.Connection(this.rws),this.storeUnsubscribe=this.$store.subscribe(this.onStoreMutation);case 7:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}(),beforeDestroy:function(){window.removeEventListener("keypress",this.keyPressHandler),this.storeUnsubscribe(),this.doc&&this.doc.destroy(),this.connection.close(),this.rws.close()}}),kt=yt,Ot=(i("50cf"),i("8ecc"),i("6964"),Object(v["a"])(kt,c,u,!1,null,null,null)),wt=Ot.exports,xt=(i("a434"),i("aced"));function Mt(e,t,i){e.ui.activeMapId!==t&&i("ui/setActiveMapId",{mapId:t},{root:!0})}function jt(e,t,i){if(e.ui.activeMapId===t){for(var a,n=0,r=Object.keys(e.maps.maps);n<r.length;n++){var s=r[n];if(s!==t){a=s;break}}i("ui/setActiveMapId",{mapId:a},{root:!0})}}var St=function(){return{maps:{}}},Pt={activeMap:function(e,t,i){var a=i.ui.activeMapId,n=e.maps[a];return n}},_t={undo:function(){xt["a"].open({message:"Not yet implemented ðŸ˜”",type:"is-danger"})},redo:function(){xt["a"].open({message:"Not yet implemented ðŸ˜”",type:"is-danger"})},setMaps:function(e,t){var i=e.commit,a=e.rootState,n=t.maps,r=t.source;if(i("setMaps",{maps:n,source:r}),Object.keys(n).length){var s=Object.keys(n)[0];s&&Mt(a,s,i)}},resetMaps:function(e){var t=e.dispatch;t("setMaps",{maps:{}})},insertMap:function(e,t){var i=e.commit,a=e.rootState,n=t.mapId,r=t.pixelMask,s=void 0===r?[]:r,o=t.gcps,c=void 0===o?{}:o,u=t.image,p=t.source,l={version:2,id:n,image:u,pixelMask:s,gcps:c};i("insertMap",{mapId:n,map:l,source:p}),Mt(a,n,i)},removeMap:function(e,t){var i=e.commit,a=e.rootState,n=t.mapId,r=t.source;jt(a,n,i),i("removeMap",{mapId:n,source:r})},insertPixelMaskPoint:function(e,t){var i=e.state,a=e.commit,n=e.rootState,r=t.mapId,s=t.index,o=t.pixelMaskPoint,c=t.source;if(!i.maps[r])throw new Error("Map ".concat(r," does not exist"));a("insertPixelMaskPoint",{mapId:r,index:s,pixelMaskPoint:o,source:c}),Mt(n,r,a)},replacePixelMaskPoint:function(e,t){var i=e.commit,a=e.rootState,n=t.mapId,r=t.index,s=t.pixelMaskPoint,o=t.source;i("replacePixelMaskPoint",{mapId:n,index:r,pixelMaskPoint:s,source:o}),Mt(a,n,i)},removePixelMaskPoint:function(e,t){var i=e.commit,a=e.rootState,n=t.mapId,r=t.index,s=t.source;i("removePixelMaskPoint",{mapId:n,index:r,source:s}),Mt(a,n,i)},insertGcp:function(e,t){var i=e.state,a=e.commit,n=t.mapId,r=t.gcpId,s=t.gcp,o=t.source;if(!i.maps[n])throw new Error("Map ".concat(n," does not exist"));if(i.maps[n].gcps[r])throw new Error("GCP ".concat(r," already exists"));a("insertGcp",{mapId:n,gcpId:r,gcp:s,source:o})},replaceGcp:function(e,t){var i=e.state,a=e.commit,n=t.mapId,r=t.gcpId,s=t.gcp,o=t.source;if(!i.maps[n])throw new Error("Map ".concat(n," does not exist"));if(!i.maps[n].gcps[r])throw new Error("GCP ".concat(r," does not exist"));a("replaceGcp",{mapId:n,gcpId:r,gcp:s,source:o})},removeGcp:function(e,t){var i=e.state,a=e.commit,n=t.mapId,r=t.gcpId,s=t.gcp,o=t.source;if(!i.maps[n])throw new Error("Map ".concat(n," does not exist"));if(!i.maps[n].gcps[r])throw new Error("GCP ".concat(r," does not exist"));a("removeGcp",{mapId:n,gcpId:r,gcp:s,source:o})}},Ct={setMaps:function(e,t){var i=t.maps;e.maps=i},insertMap:function(e,t){var i=t.mapId,n=t.map;if(e.maps[i])throw new Error("Map already exists!");a["a"].set(e.maps,i,n)},removeMap:function(e,t){var i=t.mapId;a["a"].delete(e.maps,i)},insertPixelMaskPoint:function(e,t){var i=t.mapId,n=t.index,r=t.pixelMaskPoint,s=e.maps[i],o=s.pixelMask;o.splice(n,0,r),a["a"].set(e.maps,i,s)},replacePixelMaskPoint:function(e,t){var i=t.mapId,n=t.index,r=t.pixelMaskPoint,s=e.maps[i];s.pixelMask[n]=r,a["a"].set(e.maps,i,s)},removePixelMaskPoint:function(e,t){var i=t.mapId,n=t.index,r=e.maps[i];r.pixelMask.splice(n,1),a["a"].set(e.maps,i,r)},insertGcp:function(e,t){var i=t.mapId,n=t.gcpId,r=t.gcp,s=e.maps[i];a["a"].set(s.gcps,n,Object(l["a"])({id:n},r)),a["a"].set(e.maps,i,s)},replaceGcp:function(e,t){var i=t.mapId,n=t.gcpId,r=t.gcp,s=e.maps[i];a["a"].set(s.gcps,n,Object(l["a"])({id:n},r)),a["a"].set(e.maps,i,s)},removeGcp:function(e,t){var i=t.mapId,n=t.gcpId,r=e.maps[i];a["a"].delete(r.gcps,n),a["a"].set(e.maps,i,r)}},Et={namespaced:!0,state:St,getters:Pt,actions:_t,mutations:Ct},Gt=(i("c975"),function(){return{sidebarOpen:!1,drawerOpen:void 0,lastError:void 0,activeImageId:void 0,activeMapId:void 0,loading:!1}}),$t={activeImage:function(e,t,i){return i.iiif.imagesById[e.activeImageId]},previousMapId:function(e,t,i){if(e.activeMapId){var a=Object.keys(i.maps.maps),n=a.indexOf(e.activeMapId),r=(n-1+a.length)%a.length;return a[r]}},nextMapId:function(e,t,i){if(e.activeMapId){var a=Object.keys(i.maps.maps),n=a.indexOf(e.activeMapId),r=(n+1+a.length)%a.length;return a[r]}}},Ft={setActiveImageId:function(e,t){var i=e.commit,a=e.dispatch,n=e.rootState,r=t.imageId;if(!n.iiif.imagesById[r])throw new Error("Image ID does not exist in IIIF source: ".concat(r));a("maps/resetMaps",{maps:{}},{root:!0}),i("setActiveImageId",{imageId:r}),i("setActiveMapId",{mapId:void 0})},setActiveMapId:function(e,t){var i=e.commit,a=e.rootState,n=t.mapId;a.maps.maps[n]&&i("setActiveMapId",{mapId:n})},setSidebarOpen:function(e,t){var i=e.state,a=e.commit,n=t.open;i.sidebarOpen!==n&&a("setSidebarOpen",{open:n})},toggleDrawer:function(e,t){var i=e.state,a=e.commit,n=i.drawerOpen===t?void 0:t;a("setDrawerOpen",{drawer:n})}},Tt={setActiveImageId:function(e,t){var i=t.imageId;e.activeImageId=i},setActiveMapId:function(e,t){var i=t.mapId;e.activeMapId=i},setSidebarOpen:function(e,t){var i=t.open;e.sidebarOpen=i},setDrawerOpen:function(e,t){var i=t.drawer;e.drawerOpen=i}},At={namespaced:!0,state:Gt,getters:$t,actions:Ft,mutations:Tt},Rt=(i("2532"),i("b85c")),qt="https://api.allmaps.org";function Dt(e){return fetch(e).then((function(e){return e.json()}))}function Ut(e,t,i,a){return Lt.apply(this,arguments)}function Lt(){return Lt=Object(p["a"])(regeneratorRuntime.mark((function e(t,i,a,n){var r,s,o,c,u;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Object(Le["a"])(n);case 2:return r=e.sent,s="".concat(qt,"/").concat(i,"s/").concat(a),o={url:t,checksum:r},e.next=7,fetch(s,{method:"PUT",headers:{"Content-type":"application/json"},body:JSON.stringify(o)});case 7:return c=e.sent,e.next=10,c.json();case 10:return u=e.sent,e.abrupt("return",u);case 12:case"end":return e.stop()}}),e)}))),Lt.apply(this,arguments)}function zt(e){if(Array.isArray(e))return zt(e[0]);if("object"===Object(dt["a"])(e))return e.en?zt(e.en):zt(Object.values(e)[0]);if("object"===Object(dt["a"])(e)&&e["@value"])return zt(e["@value"]);if(e&&e.includes("<")){var t=(new DOMParser).parseFromString(e,"text/html");return t.body.textContent||""}return e}var Bt={loaded:!1,url:void 0,type:void 0,parsedIiif:void 0,imagesById:{}},Nt=function(){return Bt},Vt={manifestId:function(e){return"manifest"===e.parsedIiif.type&&e.parsedIiif.id},imageCount:function(e){return Object.keys(e.imagesById).length},label:function(e){return e.parsedIiif&&zt(e.parsedIiif.sourceData.label)},description:function(e){return e.parsedIiif&&zt(e.parsedIiif.sourceData.description)},metadata:function(e){if(e.parsedIiif&&e.parsedIiif.sourceData.metadata&&e.parsedIiif.sourceData.metadata.length)return e.parsedIiif.sourceData.metadata.map((function(e){var t=e.label,i=e.value;return{label:zt(t),value:zt(i)}})).filter((function(e){var t=e.label,i=e.value;return t&&i}))}},Ht={setIiifUrl:function(e,t){return Object(p["a"])(regeneratorRuntime.mark((function i(){var a,n,r,s,o,c,u,p,d,m,f,h,g,v;return regeneratorRuntime.wrap((function(i){while(1)switch(i.prev=i.next){case 0:if(a=e.commit,n=e.dispatch,r=t.url,s=t.imageId,r){i.next=4;break}return i.abrupt("return");case 4:return a("maps/setMaps",{maps:{}},{root:!0}),i.next=7,Dt(r);case 7:return o=i.sent,c=Object(ue["c"])(o),u=c.type,i.next=12,Object(Le["b"])(c.uri);case 12:if(c.id=i.sent,"image"!==u){i.next=17;break}c.stub=!1,i.next=40;break;case 17:if("manifest"!==u){i.next=39;break}p=Object(Rt["a"])(c.images),i.prev=19,p.s();case 21:if((d=p.n()).done){i.next=29;break}return m=d.value,i.next=25,Object(Le["b"])(m.uri);case 25:m.id=i.sent,m.stub=!0;case 27:i.next=21;break;case 29:i.next=34;break;case 31:i.prev=31,i.t0=i["catch"](19),p.e(i.t0);case 34:return i.prev=34,p.f(),i.finish(34);case 37:i.next=40;break;case 39:throw new Error("Unsupported IIIF type: ".concat(u));case 40:Ut(r,c.type,c.id,o),f="image"===u?[c]:c.images,h=f.reduce((function(e,t,i){return Object(l["a"])(Object(l["a"])({},e),{},Object(ye["a"])({},t.id,Object(l["a"])(Object(l["a"])({},t),{},{index:i,previousImageId:f[i-1]&&f[i-1].id,nextImageId:f[i+1]&&f[i+1].id})))}),{}),a("setIiif",{url:r,type:u,parsedIiif:c,imagesById:h}),s&&h[s]?v=s:(v=f[0].id,g={name:Qt.currentRoute.name,query:Object(l["a"])(Object(l["a"])({},Qt.currentRoute.query),{},{image:v})}),h[v].stub&&n("loadImageInfo",{imageId:v}),g&&Qt.push(g),a("ui/setActiveImageId",{imageId:v},{root:!0}),"manifest"===c.type&&f.filter((function(e){return e.stub})).forEach((function(e){return n("loadImageInfo",{imageId:e.id})}));case 49:case"end":return i.stop()}}),i,null,[[19,31,34,37]])})))()},loadImageInfo:function(e,t){return Object(p["a"])(regeneratorRuntime.mark((function i(){var a,n,r,s,o,c,u,p,d;return regeneratorRuntime.wrap((function(i){while(1)switch(i.prev=i.next){case 0:if(a=e.state,n=e.commit,r=t.imageId,!a.imagesById[r]||!a.imagesById[r].stub){i.next=30;break}return s=a.imagesById[r],o="".concat(s.uri,"/info.json"),i.next=7,Dt(o);case 7:if(c=i.sent,u=Object(ue["c"])(c),p=u.type,"image"!==p){i.next=29;break}return i.t0=l["a"],i.t1=Object(l["a"])({},u),i.t2={},i.next=16,Object(Le["b"])(u.uri);case 16:if(i.t3=i.sent,i.t4=s.index,i.t5=s.previousImageId,i.t6=s.nextImageId,i.t7={id:i.t3,stub:!1,index:i.t4,previousImageId:i.t5,nextImageId:i.t6},d=(0,i.t0)(i.t1,i.t2,i.t7),d.id!==r){i.next=26;break}n("setImage",{imageId:r,parsedImage:d}),i.next=27;break;case 26:throw new Error("Image IDs don't match");case 27:i.next=30;break;case 29:throw new Error("IIIF data is not an image");case 30:case"end":return i.stop()}}),i)})))()}},Jt={setIiif:function(e,t){var i=t.url,a=t.type,n=t.parsedIiif,r=t.imagesById;e.loaded=!0,e.url=i,e.type=a,e.parsedIiif=n,e.imagesById=r},setImage:function(e,t){var i=t.imageId,n=t.parsedImage;a["a"].set(e.imagesById,i,n)}},Wt={namespaced:!0,state:Nt,getters:Vt,actions:Ht,mutations:Jt};a["a"].use(d["a"]);var Kt=new d["a"].Store({modules:{maps:Et,ui:At,iiif:Wt}});a["a"].use(n["a"]),a["a"].use(r["a"],{defaultIconPack:"fas",defaultContainerElement:"#content"}),a["a"].config.productionTip=!1,a["a"].directive("highlightjs",{deep:!0,bind:function(e,t){var i=e.querySelectorAll("code");i.forEach((function(e){t.value&&(e.textContent=t.value),o.a.highlightBlock(e)}))},componentUpdated:function(e,t){var i=e.querySelectorAll("code");i.forEach((function(e){t.value&&(e.textContent=t.value,o.a.highlightBlock(e))}))}});var Qt=new n["a"]({routes:[{name:"home",path:"/",component:wt},{name:"collection",path:"/collection",component:wt},{name:"georeference",path:"/georeference",component:wt},{name:"mask",path:"/mask",component:wt},{name:"results",path:"/results",component:wt}]});new a["a"]({router:Qt,store:Kt,render:function(e){return e(wt)}}).$mount("#app")},6:function(e,t){},"645a":function(e,t,i){"use strict";i("444d")},"66b3":function(e,t,i){},"67b8":function(e,t,i){"use strict";i("d7d7")},6964:function(e,t,i){"use strict";i("7dff")},"6e9d":function(e,t,i){},7:function(e,t){},"7dff":function(e,t,i){},"7eda":function(e,t,i){},8:function(e,t){},"8c5d":function(e,t,i){},9:function(e,t){},"9f46":function(e,t,i){},"9f69":function(e,t,i){"use strict";i("f349")},ca39:function(e,t,i){"use strict";i("3413")},cc7b:function(e,t,i){"use strict";i("7eda")},d7d7:function(e,t,i){},e3b5:function(e,t,i){},f349:function(e,t,i){},fbb4:function(e,t,i){"use strict";i("2b65")},fc82:function(e,t,i){"use strict";i("66b3")}});
//# sourceMappingURL=app.8b57a3f6.js.map